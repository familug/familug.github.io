<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="hvn" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="aws, sqs, pitfall, trap, message queue, frontpage, " />

<meta property="og:title" content="[AWS][SQS] Queue service dễ dùng, mà toàn trap "/>
<meta property="og:url" content="./awssqs-queue-service-de-dung-ma-toan-trap.html" />
<meta property="og:description" content="Trong ba vạn sáu ngàn chín trăm service của AWS cung cấp, mỗi cái một kiểu, có this có that. EC2, ALB, RDS, S3, SQS, Lambda là những cái tên &#34;cơ bản&#34; nhất, cũng là phổ biến nhất. Đặc điểm chung là dễ dùng, đắt, và cũng dễ dính trap …" />
<meta property="og:site_name" content="FAMILUG.org Vietnam" />
<meta property="og:article:author" content="hvn" />
<meta property="og:article:published_time" content="2022-10-17T00:00:00+07:00" />
<meta name="twitter:title" content="[AWS][SQS] Queue service dễ dùng, mà toàn trap ">
<meta name="twitter:description" content="Trong ba vạn sáu ngàn chín trăm service của AWS cung cấp, mỗi cái một kiểu, có this có that. EC2, ALB, RDS, S3, SQS, Lambda là những cái tên &#34;cơ bản&#34; nhất, cũng là phổ biến nhất. Đặc điểm chung là dễ dùng, đắt, và cũng dễ dính trap …">

        <title>[AWS][SQS] Queue service dễ dùng, mà toàn trap  · FAMILUG.org Vietnam
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>FAMILUG.org Vietnam</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./awssqs-queue-service-de-dung-ma-toan-trap.html">
                [AWS][SQS] Queue service dễ dùng, mà toàn trap
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Trong ba vạn sáu ngàn chín trăm service của AWS cung cấp, mỗi cái một kiểu, có this có that.
EC2, ALB, RDS, S3, SQS, Lambda là những cái tên "cơ bản" nhất, cũng là
phổ biến nhất.</p>
<p>Đặc điểm chung là dễ dùng, đắt, và cũng dễ dính trap!!!</p>
<p>Let's go.</p>
<p>SQS là viết tắt của chữ <a href="https://docs.aws.amazon.com/sqs/index.html">Simple Queue Service</a>, một dịch vụ cloud khá tương đương với các
phần mềm message queue dưới đất như:</p>
<ul>
<li>RabbitMQ</li>
<li>ActiveMQ</li>
<li>IronMQ</li>
</ul>
<p><img alt="itatrap" src="https://images.unsplash.com/photo-1611701600139-0d468e20c9a1?ixlib=rb-1.2.1&amp;dl=nick-fewings-Z2yXfJEu5rI-unsplash.jpg&amp;w=640&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb"></p>
<p>Photo by <a href="https://unsplash.com/@jannerboy62?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Nick Fewings</a> on <a href="https://unsplash.com/s/photos/trap?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a></p>
<p>Nếu bạn chưa nghe tên cả 3, thì nó giống như 1 cái ống nước, một đầu gửi thư,
đầu kia nhận thư, nếu không ai nhận thì nó nằm trong cái ống.</p>
<p>Vì chỉ đơn giản có vậy, nên sau khi tạo 1 cái queue, thì dùng nó chỉ có 3 thao tác:</p>
<ul>
<li>gửi message</li>
<li>nhận message</li>
<li>xóa message</li>
</ul>
<p>message có thể là 1 đoạn text format JSON.</p>
<p>PS: bài viết không yêu cầu code Python, chỉ dùng minh họa.</p>
<p>Sử dụng Python lib boto3, mọi chuyện đơn giản đúng như nói. Ví dụ lấy từ
tutorial của boto3 <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/sqs.html">https://boto3.amazonaws.com/v1/documentation/api/latest/guide/sqs.html</a></p>
<h3>Tạo SQS queue</h3>
<div class="highlight"><pre><span></span><code><span class="n">sqs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">)</span>

<span class="c1"># Create the queue. This returns an SQS.Queue instance</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">create_queue</span><span class="p">(</span><span class="n">QueueName</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">Attributes</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;DelaySeconds&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">})</span>

<span class="c1"># You can now access identifiers and attributes</span>
<span class="nb">print</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DelaySeconds&#39;</span><span class="p">))</span>
</code></pre></div>

<h3>Gửi SQS message</h3>
<div class="highlight"><pre><span></span><code><span class="n">sqs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">)</span>

<span class="c1"># Get the queue</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">get_queue_by_name</span><span class="p">(</span><span class="n">QueueName</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="c1"># Create a new message</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">send_messages</span><span class="p">(</span><span class="n">Entries</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MessageBody&#39;</span><span class="p">:</span> <span class="s1">&#39;world&#39;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MessageBody&#39;</span><span class="p">:</span> <span class="s1">&#39;boto3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;MessageAttributes&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Author&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;StringValue&#39;</span><span class="p">:</span> <span class="s1">&#39;Daniel&#39;</span><span class="p">,</span>
                <span class="s1">&#39;DataType&#39;</span><span class="p">:</span> <span class="s1">&#39;String&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">])</span>
</code></pre></div>

<h3>Nhận message rồi xử lý và xóa</h3>
<p>Một mô hình đơn giản đó là có 1 đầu gửi lệnh tới SQS queue, đầu kia sẽ nhận
lệnh và xử lý.</p>
<p>Nhận:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Get the service resource</span>
<span class="n">sqs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">)</span>

<span class="c1"># Get the queue</span>
<span class="n">queue</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">get_queue_by_name</span><span class="p">(</span><span class="n">QueueName</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="c1"># Process messages by printing out body and optional author name</span>
    <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">queue</span><span class="o">.</span><span class="n">receive_messages</span><span class="p">(</span><span class="n">MessageAttributeNames</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Author&#39;</span><span class="p">]):</span>
        <span class="c1"># Get the custom author message attribute if it was set</span>
        <span class="n">author_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">message_attributes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">author_name</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">message_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;StringValue&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">author_name</span><span class="p">:</span>
                <span class="n">author_text</span> <span class="o">=</span> <span class="s1">&#39; (</span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">author_name</span><span class="p">)</span>

        <span class="c1"># Print out the body and author (if set)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello, </span><span class="si">{0}</span><span class="s1">!</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">author_text</span><span class="p">))</span>

        <span class="c1"># Let the queue know that the message is processed</span>
        <span class="n">message</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</code></pre></div>

<p>Hết tutorial, quá dễ, quá đơn giản!!!</p>
<h3>Traps</h3>
<p>Hãy thử nghĩ các vẫn đề có thể xảy ra liên quan đến SQS ở đoạn code trên
trước khi đọc tiếp, đây chỉ nói về SQS, không nói về code Python.</p>
<h4>Trap 1: delete() chưa chắc đã delete message</h4>
<p>Ở đây không nói về lỗi network.
Đó có lẽ là điều cuối cùng bạn nghĩ tới, khi <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sqs.html#SQS.Client.delete_message">function delete đôi khi sẽ không
delete</a></p>
<p>Điều này có ghi rõ 2 trường hợp có thể xảy ra chuyện này, và tất nhiên chỉ
ai nhìn delete() mà không tin nó sẽ delete mới đọc <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sqs.html#SQS.Client.delete_message">doc</a>:</p>
<p>Trường hợp 1 là khi dùng SQS standard queue.</p>
<blockquote>
<p>For standard queues, it is possible to receive a message even after you
delete it. This might happen on rare occasions if one of the servers which
stores a copy of the message is unavailable when you send the request to
delete the message. The copy remains on the server and might be returned to
you during a subsequent receive request. You should ensure that your
application is idempotent, so that receiving a message more than once does
not cause issues.</p>
</blockquote>
<p>Yep, SQS có 2 loại queue, 1 là standard queue (cũ) 2 là <a href="https://aws.amazon.com/blogs/aws/new-for-amazon-simple-queue-service-fifo-queues-with-exactly-once-delivery-deduplication/">FIFO queue</a> mới ra đời vào 2016, sau 12 năm tồn tại của SQS với vô số "bí mật".
Standard queue có thể xảy ra trường hợp delete xong mà vẫn còn message.</p>
<p>Nếu ai từng học về cấu trúc dữ liệu trong lập trình, kiểu queue có nghĩa là phải FIFO (first-in first-out), thì queue của AWS có 2 loại là 1 không FIFO và 1 FIFO.</p>
<p>Trường hợp thứ 2, tinh vi hơn:</p>
<blockquote>
<p>The ReceiptHandle is associated with a specific instance of receiving a message. If you receive a message more than once, the ReceiptHandle is different each time you receive a message. When you use the DeleteMessage action, you must provide the most recently received ReceiptHandle for the message (otherwise, the request succeeds, but the message might not be deleted).</p>
</blockquote>
<p>Tức nếu có</p>
<ul>
<li>C1 nhận messageA xử lý,</li>
<li>rồi C2 nhận messageA xử lý</li>
<li>C1 delete message -&gt; return success, nhưng không thực sự xóa</li>
<li>C2 delete message -&gt; nếu không có thằng nào khác (C3, C4...) thì mới xóa.</li>
</ul>
<p>C1 và C2 có thể nhận cùng 1 message, nếu 1 hệ thống có nhiều worker cùng hoạt động, cùng gọi
SQS, thì ban đầu chỉ C1 nhận được messageA, nhưng sau <code>visibility timeout</code> mặc định 30s, C2 cũng sẽ nhìn thấy messageA.
Chỉ với 1 message có visibility timeout 30s, và 2 worker xử lý mỗi message sau 50s, bạn đã tạo được 1 vòng lặp gần vô hạn!</p>
<p><img alt="img" src="./images/graph.jpg"></p>
<h4>Trap2</h4>
<p><code>receive_messages</code> kể cả không nhận được message nào, cũng mất phí. Nhìn chung thì
<a href="https://aws.amazon.com/sqs/pricing/">cứ gọi API của AWS là tính phí rồi</a>, nên cái này không đến nỗi quá bất ngờ.
Nhưng khi chứng kiến các backend engineer viết app "scale"/concurrency/parallel, gọi hàng triệu call mỗi 10 giây,
số tiền bạn phải trả AWS 1 tháng đủ để trả lương kỹ sư ấy cả năm.</p>
<p>$0.4/1_000_000 call =&gt; 86400/10 * 0.4 == $3_456/ngày.</p>
<h4>Trap N</h4>
<p>Ôi dào, đấy là do không chịu đọc doc của từng function thôi.</p>
<p>Okie bạn ơi, còn 31 cái warning 56 cái note trong tài liệu này, chúc vui!
<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sqs.html">https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sqs.html</a></p>
<p>Còn trang tutorial thân thiện, thì không có gì.
<a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/sqs.html">https://boto3.amazonaws.com/v1/documentation/api/latest/guide/sqs.html</a></p>
<h3>Kết luận</h3>
<p>AWS dễ, mà trap everywhere, và mỗi bài học phải được trả bằng tiền, rất nhiều tiền!</p>
<p>Có trong tay full các chứng chỉ cloud của 1 nhà cung cấp cloud hàng đầu (không phải AWS),
tôi không tin có chứng chỉ nào dạy cho bạn những điều này.</p>
<p>Đó là việc của "best practice", của các chuyên gia tư vấn sẽ tới thăm bạn và xin cục tiền.</p>
<p>PS: Nếu lỗi nào có được đào tạo khi luyện thi các chứng chỉ của AWS, các chuyên
gia AWS full chứng chỉ vui lòng PM mình để update vào đây, tạo động lực thi chứng chỉ cho quần chúng.</p>
<p>Happy crying!</p>
<p>Hết.</p>
<p>HVN at http://pymi.vn and https://www.familug.org.</p>
<p><a href="https://www.familug.org/p/ung-ho.html">Ủng hộ tác giả 🍺</a></p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2022-10-17T00:00:00+07:00">Mon 17 October 2022</time>
            <h4>Category</h4>
            <a class="category-link" href="./categories.html#frontpage-ref">frontpage</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#aws-ref">aws
                    <span class="superscript">2</span>
</a></li>
                <li><a href="./tags.html#message-queue-ref">message queue
                    <span class="superscript">1</span>
</a></li>
                <li><a href="./tags.html#pitfall-ref">pitfall
                    <span class="superscript">5</span>
</a></li>
                <li><a href="./tags.html#sqs-ref">sqs
                    <span class="superscript">1</span>
</a></li>
                <li><a href="./tags.html#trap-ref">trap
                    <span class="superscript">1</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="./theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>