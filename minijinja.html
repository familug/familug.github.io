<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="hvn" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="rust, jinja2, minijinja, askama, frontpage, " />

<meta property="og:title" content="Những bất ngờ khi dùng Rust minijinja của tác giả Jinja2 "/>
<meta property="og:url" content="./minijinja.html" />
<meta property="og:description" content="Khi dùng Rust, người dùng thường có cảm giác an toàn: nếu nó compile, nó sẽ chạy đúng. Điều này không viết ở đâu trong tài liệu cả, và chỉ là ảo tưởng của người dùng (hello AI hallucination). minijinja https://github.com/mitsuhiko/minijinja/ là thư viện giống jinja2 …" />
<meta property="og:site_name" content="FAMILUG.org Vietnam" />
<meta property="og:article:author" content="hvn" />
<meta property="og:article:published_time" content="2025-02-07T00:00:00+07:00" />
<meta name="twitter:title" content="Những bất ngờ khi dùng Rust minijinja của tác giả Jinja2 ">
<meta name="twitter:description" content="Khi dùng Rust, người dùng thường có cảm giác an toàn: nếu nó compile, nó sẽ chạy đúng. Điều này không viết ở đâu trong tài liệu cả, và chỉ là ảo tưởng của người dùng (hello AI hallucination). minijinja https://github.com/mitsuhiko/minijinja/ là thư viện giống jinja2 …">

        <title>Những bất ngờ khi dùng Rust minijinja của tác giả Jinja2  · FAMILUG.org Vietnam
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>FAMILUG.org Vietnam</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./minijinja.html">
                Những bất ngờ khi dùng Rust minijinja của tác giả Jinja2
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Khi dùng Rust, người dùng thường có cảm giác an toàn: nếu nó compile, nó sẽ chạy đúng.
Điều này không viết ở đâu trong tài liệu cả, và chỉ là ảo tưởng của người dùng (hello AI hallucination).</p>
<p>minijinja <a href="https://github.com/mitsuhiko/minijinja/">https://github.com/mitsuhiko/minijinja/</a> là thư viện giống jinja2 của tác giả mitsuhiko, viết cho Rust.
Dùng minijinja có syntax giống như Jinja2, đỡ phải học thêm gi mới, thế nhưng, vẫn có những bất ngờ.</p>
<p>Code:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// cargo add minijinja serde --features serde/derive</span>
<span class="k">use</span><span class="w"> </span><span class="n">minijinja</span>::<span class="p">{</span><span class="n">Environment</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="n">Serialize</span><span class="p">;</span><span class="w"></span>

<span class="k">mod</span> <span class="nn">models</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="n">Serialize</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="cp">#[derive(Debug, Serialize)]</span><span class="w"></span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Profile</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">email</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Profile</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">Profile</span><span class="p">{</span><span class="n">email</span>: <span class="s">&quot;info@debian.com&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[derive(Debug, Serialize)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">address</span>: <span class="nb">String</span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Environment</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">User</span><span class="p">{</span><span class="n">name</span>: <span class="s">&quot;Pikachu&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">address</span>: <span class="s">&quot;Japan&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">models</span>::<span class="n">new</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">env</span><span class="p">.</span><span class="n">add_template</span><span class="p">(</span><span class="s">&quot;hello.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello {{ user.name }} from address {{ user.addres }} email {{ profile.email }} !&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&quot;hello.txt&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">template</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="p">}).</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<p>Kết quả:</p>
<div class="highlight"><pre><span></span><code>$ cargo run

Hello Pikachu from address  email info@debian.com !
</code></pre></div>

<h3>Không phát hiện được typo trong tên field</h3>
<p>Trước hết, address trong output bị bỏ trống. Lý do trong template gõ nhầm field <code>addres</code> thay vì <code>address</code>, người dùng có thể mong đợi chương trình sẽ compile fail nhưng ở đây lại thành công lặng lẽ và output empty string.</p>
<p>Giải pháp: dùng thư viện hỗ trợ check ở compile time như <a href="https://github.com/rinja-rs/askama">askama</a> có hỗ trợ <code>Benefit from the safety provided by Rust's type system</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">askama</span>::<span class="n">Template</span><span class="p">;</span><span class="w"> </span><span class="c1">// bring trait in scope</span>

<span class="cp">#[derive(Template)]</span><span class="w"> </span><span class="c1">// this will generate the code...</span>
<span class="cp">#[template(path = </span><span class="s">&quot;hello.html&quot;</span><span class="cp">)]</span><span class="w"> </span><span class="c1">// using the template in this path, relative</span>
<span class="w">                                 </span><span class="c1">// to the `templates` dir in the crate root</span>
<span class="k">struct</span> <span class="nc">HelloTemplate</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// the name of the struct can be anything</span>
<span class="w">    </span><span class="n">user</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="nc">User</span><span class="p">,</span><span class="w"> </span><span class="c1">// the field name should match the variable name</span>
<span class="w">                   </span><span class="c1">// in your template</span>
<span class="p">}</span><span class="w"></span>


<span class="cp">#[derive(Debug)]</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">address</span>: <span class="nb">String</span>
<span class="p">}</span><span class="w"></span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">User</span><span class="p">{</span><span class="n">name</span>: <span class="s">&quot;Pikachu&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">address</span>: <span class="s">&quot;Japan&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HelloTemplate</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">user</span>: <span class="kp">&amp;</span><span class="nc">user</span><span class="w"> </span><span class="p">};</span><span class="w"> </span><span class="c1">// instantiate your struct</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hello</span><span class="p">.</span><span class="n">render</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span><span class="w"> </span><span class="c1">// then render it.</span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>// templates/hello.html
&quot;Hello {{ user.name }} from address {{ user.addres }} !&quot;
</code></pre></div>

<p>Báo lỗi như sau khi build:</p>
<div class="highlight"><pre><span></span><code><span class="k">error</span><span class="err">[</span><span class="n">E0609</span><span class="err">]</span><span class="o">:</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">field</span><span class="w"> </span><span class="n n-Quoted">`addres`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="n n-Quoted">`&amp;&#39;a User`</span><span class="w"></span>
</code></pre></div>

<h3>Truy cập được nội dung private field trong struct</h3>
<p>Bất ngờ thứ 2 field email, dù không phải public, vẫn truy cập được từ mod khác, do sử dụng <code>derive(Serialize)</code>, có thể sẽ có ngày có người lộ password field.</p>
<p>Giải pháp: dùng skip để bỏ skip các field không mong muốn <a href="https://serde.rs/attr-skip-serializing.html">https://serde.rs/attr-skip-serializing.html</a></p>
<h3>Kết luận</h3>
<p>Không phải cứ dùng Rust là sẽ an toàn, hãy dùng biện pháp an toàn khi cần thiết.</p>
<p>Hết.</p>
<p>HVN at <a href="https://pymi.vn">https://pymi.vn</a> and <a href="https://www.familug.org">https://www.familug.org</a>.</p>
<p><a href="https://www.familug.org/p/ung-ho.html">Ủng hộ tác giả 🍺</a></p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2025-02-07T00:00:00+07:00">Fri 07 February 2025</time>
            <h4>Category</h4>
            <a class="category-link" href="./categories.html#frontpage-ref">frontpage</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#askama-ref">askama
                    <span class="superscript">1</span>
</a></li>
                <li><a href="./tags.html#jinja2-ref">jinja2
                    <span class="superscript">1</span>
</a></li>
                <li><a href="./tags.html#minijinja-ref">minijinja
                    <span class="superscript">1</span>
</a></li>
                <li><a href="./tags.html#rust-ref">rust
                    <span class="superscript">12</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="./theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>