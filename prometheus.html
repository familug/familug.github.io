<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="./theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="./theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="hvn" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="readcode, go, prometheus, metric, timeseries, frontpage, " />

<meta property="og:title" content="Prometheus căn bản "/>
<meta property="og:url" content="./prometheus.html" />
<meta property="og:description" content="Căn bản không nghĩa là đơn giản hay dễ. Điều này càng đúng khi nói về time series database (TSDB) như Prometheus. Time series là 1 nhánh của toán học, mà chỉ có 1 thứ dễ khi nói về toán, đó là dễ sai. Thời gian là 1 khái niệm …" />
<meta property="og:site_name" content="FAMILUG.org Vietnam" />
<meta property="og:article:author" content="hvn" />
<meta property="og:article:published_time" content="2024-10-02T00:00:00+07:00" />
<meta property="og:article:modified_time" content="2024-10-10T00:00:00+07:00" />
<meta name="twitter:title" content="Prometheus căn bản ">
<meta name="twitter:description" content="Căn bản không nghĩa là đơn giản hay dễ. Điều này càng đúng khi nói về time series database (TSDB) như Prometheus. Time series là 1 nhánh của toán học, mà chỉ có 1 thứ dễ khi nói về toán, đó là dễ sai. Thời gian là 1 khái niệm …">

        <title>Prometheus căn bản  · FAMILUG.org Vietnam
</title>



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="./"><span class=site-name>FAMILUG.org Vietnam</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       .
                                    >Home</a>
                                </li>
                                <li ><a href="./categories.html">Categories</a></li>
                                <li ><a href="./tags.html">Tags</a></li>
                                <li ><a href="./archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="./search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="./prometheus.html">
                Prometheus căn bản
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>Căn bản không nghĩa là đơn giản hay dễ.
Điều này càng đúng khi nói về time series database (TSDB) như Prometheus. <a href="https://en.wikipedia.org/wiki/Time_series">Time series</a> là 1 nhánh của toán học, mà chỉ có 1 thứ dễ khi nói về toán, đó là dễ sai.
Thời gian là 1 khái niệm không được định nghĩa rõ ràng, chỉ có trong trí tưởng tượng của con người <a href="https://en.wikipedia.org/wiki/Time">https://en.wikipedia.org/wiki/Time</a>.</p>
<p><strong>Chú ý:</strong> vì vậy bài viết này, giống mọi bài viết khác, có thể sai.</p>
<p>Bài viết giúp trả lời các câu hỏi:</p>
<ul>
<li>Time series là gì</li>
<li>Metric và label là gì</li>
<li>Các kiểu metric</li>
<li>Các kiểu dữ liệu trong PromQL</li>
<li>Instant vector khác gì range vector</li>
<li>Instant vector selector khác gì range vector selector</li>
<li>Instant query khác gì range query</li>
<li>Operator khác gì function [bài sau]</li>
</ul>
<h2>Cài và chạy Prometheus</h2>
<p>Xem bài <a href="./prometheus_rate.html">trước</a>.</p>
<h2>Các khái niệm trong Prometheus</h2>
<h3>Data model - Timeseries</h3>
<p><a href="https://github.com/prometheus/docs/blob/c4554bded23a544ca8dfc0fd3f6360e13c084378/content/docs/concepts/data_model.md#data-model">Data model</a></p>
<blockquote>
<p>Prometheus fundamentally stores all data as time series: streams of timestamped values belonging to the same metric and the same set of labeled dimensions.</p>
</blockquote>
<p>Prometheus chứa tất cả dữ liệu như các time series (<a href="https://vi.wikipedia.org/wiki/Chu%E1%BB%97i_th%E1%BB%9Di_gian">chuỗi thời gian</a>).
Time series: một chuỗi giá trị gắn liền thời gian thuộc về cùng 1 metric và cùng label.</p>
<p>Ví dụ:</p>
<div class="highlight"><pre><span></span><code><span class="mi">2</span><span class="w"> </span><span class="mf">@1726148884.177</span><span class="w"></span>
<span class="mi">19</span><span class="w"> </span><span class="mf">@1726148899.177</span><span class="w"></span>
</code></pre></div>

<p>value có kiểu float 64 bits, timestamp được tính bằng giây từ mốc <a href="https://en.wikipedia.org/wiki/Unix_time">Unix Epoch 1/1/1970</a>, với phần milli giây sau dấu <code>.</code>. Kí hiệu <code>@</code> dùng khi hiển thị ở giao diện, để dễ phân biệt đó là phần timestamp.</p>
<p><img alt="prom_query" src="./images/prom_query.webp"></p>
<h4>Sample</h4>
<p><a href="https://github.com/prometheus/docs/blob/c4554bded23a544ca8dfc0fd3f6360e13c084378/content/docs/concepts/data_model.md#samples">Doc</a></p>
<p>Một cặp (value, timestamp) gọi là 1 sample.</p>
<h4>Metric names</h4>
<p>Metric name là tên dùng để đại diện cho thứ được đo</p>
<p>Ví dụ: <code>prometheus_http_requests_total</code></p>
<h4>Metric label</h4>
<p>Kèm với metric name, có thể dùng các cặp key-value gọi là label, mỗi label tạo thành 1 chiều (dimension) để chứa các thuộc tính khác của 1 metric.</p>
<p>Ví dụ:</p>
<div class="highlight"><pre><span></span><code>prometheus_http_requests_total{code=&quot;200&quot;} 10
prometheus_http_requests_total{code=&quot;500&quot;} 2
</code></pre></div>

<p>Cú pháp:</p>
<div class="highlight"><pre><span></span><code>&lt;metric name&gt;{&lt;label name&gt;=&lt;label value&gt;, &lt;label name2&gt;=&lt;label value2&gt;, ...}
</code></pre></div>

<p>Metric name kết hợp với đầy đủ label xác định 1 time series cụ thể.
Metric name thực chất cũng là 1 label (<code>__name__</code>), vậy nên có thể nói dùng labelset (tập các label) để xác định 1 time series cụ thể.</p>
<h3>Các kiểu metric</h3>
<p><a href="https://github.com/prometheus/docs/blob/c4554bded23a544ca8dfc0fd3f6360e13c084378/content/docs/concepts/metric_types.md#metric-types">Doc</a></p>
<p>Có 4 kiểu metric:</p>
<ul>
<li>Counter: counter để đếm, mỗi lần chỉ có thể giữ nguyên hay tăng lên 1 đơn vị, hoặc reset về 0. Ví dụ: đếm (tổng) số lượt truy cập website, (tổng) số lỗi xảy ra...</li>
<li>Gauge: /ɡeɪdʒ/ để đo các giá trị có thể tăng giảm tùy ý, ví dụ %CPU, %RAM.</li>
<li>Histogram: đếm các giá trị trong các khoảng chia trước (gọi là bucket). Ví dụ chia latency truy cập vào website thành các mốc 0.1s 0.2s 0.3s 0.45s, histogram metric đếm số giá trị trong các khoảng le (lower or equal) {le="0.1"} tức từ 0 đến 0.1 [0,0.1], {le=",0.2"} tức [0,0.2], {le="0.3"} tức [0,0.3], {le="0.45"} [0,0.45] và {le="+inf} [0,+inf]. Khi 1 request có latency là 0.33, các bucket {le="0.45"} và {le="+inf"} sẽ có giá trị tăng thêm 1.</li>
<li>Summary: do tác giả bài viết chưa dùng bao giờ nên bạn đọc vui lòng <a href="https://github.com/prometheus/docs/blob/c4554bded23a544ca8dfc0fd3f6360e13c084378/content/docs/concepts/metric_types.md#summary">xem tài liệu</a>.</li>
</ul>
<p>Xem thêm giải thích + hình minh họa tại <a href="https://prometheus.io/docs/tutorials/understanding_metric_types/">https://prometheus.io/docs/tutorials/understanding_metric_types/</a></p>
<h3>Các kiểu dữ liệu trong PromQL</h3>
<p><a href="https://github.com/prometheus/prometheus/blob/v2.53.0/docs/querying/basics.md#querying-prometheus">Prometheus Server &gt; Querying &gt; Basic</a> <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/">https://prometheus.io/docs/prometheus/latest/querying/basics/</a> viết</p>
<blockquote>
<p>Prometheus provides a functional query language called PromQL (Prometheus Query Language) that lets the user select and aggregate time series data in real time.</p>
</blockquote>
<p>Prometheus sử dụng 1 ngôn ngữ query tên là PromQL (Prometheus Query Language).  PromQL có 4 kiểu dữ liệu (data type):</p>
<ul>
<li>Instant vector - a set of time series containing a single sample for each time series, all sharing the same timestamp</li>
<li>Range vector - a set of time series containing a range of data points over time for each time series</li>
<li>Scalar - a simple numeric floating point value</li>
<li>String - a simple string value; currently unused</li>
</ul>
<h4>Instant vector</h4>
<p>Instant vector là 1 tập các time series, mỗi time series chứa 1 sample, tất cả đều có cùng timestamp. Ví dụ  <code>prometheus_http_requests_total</code> trả về 1 instant vector, chứa 2 timeseries:</p>
<div class="highlight"><pre><span></span><code>prometheus_http_requests_total{code=&quot;200&quot;} 10
prometheus_http_requests_total{code=&quot;500&quot;} 2
</code></pre></div>

<h4>Range vector</h4>
<p>Range vector (còn gọi là Matrix): là 1 tập các time series, mỗi time series chứa một khoảng các sample.</p>
<p>Code <a href="https://github.com/prometheus/prometheus/blob/v2.53.0/promql/value.go#L31-L34">https://github.com/prometheus/prometheus/blob/v2.53.0/promql/value.go#L31-L34</a></p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">Matrix</span><span class="p">)</span><span class="w"> </span><span class="nx">Type</span><span class="p">()</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueTypeMatrix</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">Vector</span><span class="p">)</span><span class="w"> </span><span class="nx">Type</span><span class="p">()</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueTypeVector</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">Scalar</span><span class="p">)</span><span class="w"> </span><span class="nx">Type</span><span class="p">()</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueTypeScalar</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">String</span><span class="p">)</span><span class="w"> </span><span class="nx">Type</span><span class="p">()</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueType</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">ValueTypeString</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="c1">// Series is a stream of data points belonging to a metric.</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Series</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nx">Metric</span><span class="w">     </span><span class="nx">labels</span><span class="p">.</span><span class="nx">Labels</span><span class="w"> </span><span class="s">`json:&quot;metric&quot;`</span><span class="w"></span>
<span class="w">    </span><span class="nx">Floats</span><span class="w">     </span><span class="p">[]</span><span class="nx">FPoint</span><span class="w">      </span><span class="s">`json:&quot;values,omitempty&quot;`</span><span class="w"></span>
<span class="w">    </span><span class="nx">Histograms</span><span class="w"> </span><span class="p">[]</span><span class="nx">HPoint</span><span class="w">      </span><span class="s">`json:&quot;histograms,omitempty&quot;`</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// Vector is basically only an alias for []Sample, but the contract is that</span><span class="w"></span>
<span class="c1">// in a Vector, all Samples have the same timestamp.</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Vector</span><span class="w"> </span><span class="p">[]</span><span class="nx">Sample</span><span class="w"></span>
<span class="c1">// Matrix is a slice of Series that implements sort.Interface and</span><span class="w"></span>
<span class="c1">// has a String method.</span><span class="w"></span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Matrix</span><span class="w"> </span><span class="p">[]</span><span class="nx">Series</span><span class="w"></span>
</code></pre></div>

<p>Khi nói tới Instant vector và Range vector là nói về kiểu dữ liệu (data type).</p>
<h3>Time series selectors</h3>
<p>Doc <a href="https://github.com/prometheus/prometheus/blob/v2.53.0/docs/querying/basics.md#time-series-selectors">GitHub</a> <a href="https://prometheus.io/docs/prometheus/2.53/querying/basics/#time-series-selectors">Web</a></p>
<p>Cú pháp để chọn các time series, gồm 2 loại là instant vector selector và range vector selector:</p>
<h4>instant vector selectors</h4>
<blockquote>
<p>Instant vector selectors allow the selection of a set of time series and a single sample value for each at a given timestamp (point in time).</p>
</blockquote>
<p>Instant vector selector chọn 1 tập các time series, mỗi time series 1 sample tại timestamp được chọn. Ví dụ 4 instant vector selector:</p>
<div class="highlight"><pre><span></span><code>prometheus_http_requests_total
prometheus_http_requests_total{code=&quot;200&quot;}
prometheus_http_requests_total{code!=&quot;200&quot;}
prometheus_http_requests_total{code=&quot;200&quot;, handler=&quot;/api/v1/query&quot;}
</code></pre></div>

<p>Có thể dùng regex để chọn label value</p>
<div class="highlight"><pre><span></span><code>prometheus_http_requests_total{code=~&quot;.+00&quot;, handler=~&quot;/api/v1/query.*&quot;}
</code></pre></div>

<p>Kết quả:</p>
<div class="highlight"><pre><span></span><code>prometheus_http_requests_total{code=&quot;200&quot;, handler=&quot;/api/v1/query&quot;, instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;} 7
prometheus_http_requests_total{code=&quot;200&quot;, handler=&quot;/api/v1/query_exemplars&quot;, instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;} 0
prometheus_http_requests_total{code=&quot;200&quot;, handler=&quot;/api/v1/query_range&quot;, instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;} 0
prometheus_http_requests_total{code=&quot;400&quot;, handler=&quot;/api/v1/query&quot;, instance=&quot;localhost:9090&quot;, job=&quot;prometheus&quot;} 4
</code></pre></div>

<p>Tên metric là 1 label đặc biệt <code>__name__</code>:</p>
<div class="highlight"><pre><span></span><code>{__name__=~&quot;prometheus_http_requests.*&quot;, code=~&quot;.+00&quot;, handler=~&quot;/api/v1/query.*&quot;}
</code></pre></div>

<p>cũng cho kết quả như bên trên.</p>
<h4>range vector selectors</h4>
<blockquote>
<p>Range vector literals work like instant vector literals, except that they select a range of samples back from the current instant.</p>
</blockquote>
<p>Range vector selector hoạt động giống instant vector selector, ngoại trừ việc nó chọn 1 khoảng các sample từ thời điểm hiện tại về trước. Khoảng thời gian được viết sau metric name và label, đặt trong dấu <code>[]</code>, có đơn vị s h m d w y. Ví dụ:</p>
<div class="highlight"><pre><span></span><code>prometheus_http_requests_total{handler=&quot;/api/v1/query&quot;}[1m]
</code></pre></div>

<p>trả về:</p>
<div class="highlight"><pre><span></span><code><span class="n">prometheus_http_requests_total</span><span class="p">{</span><span class="n">code</span><span class="o">=</span><span class="s">&quot;200&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="o">=</span><span class="s">&quot;/api/v1/query&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="o">=</span><span class="s">&quot;localhost:9090&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">job</span><span class="o">=</span><span class="s">&quot;prometheus&quot;</span><span class="p">}</span><span class="w"></span>
<span class="mi">90</span><span class="w"> </span><span class="mf">@1726745269.174</span><span class="w"></span>
<span class="mi">92</span><span class="w"> </span><span class="mf">@1726745284.174</span><span class="w"></span>
<span class="mi">105</span><span class="w"> </span><span class="mf">@1726745299.174</span><span class="w"></span>
<span class="mi">114</span><span class="w"> </span><span class="mf">@1726745314.174</span><span class="w"></span>

<span class="n">prometheus_http_requests_total</span><span class="p">{</span><span class="n">code</span><span class="o">=</span><span class="s">&quot;400&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">handler</span><span class="o">=</span><span class="s">&quot;/api/v1/query&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">instance</span><span class="o">=</span><span class="s">&quot;localhost:9090&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">job</span><span class="o">=</span><span class="s">&quot;prometheus&quot;</span><span class="p">}</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="mf">@1726745269.174</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="mf">@1726745284.174</span><span class="w"></span>
<span class="mi">1</span><span class="w"> </span><span class="mf">@1726745299.174</span><span class="w"></span>
<span class="mi">3</span><span class="w"> </span><span class="mf">@1726745314.174</span><span class="w"></span>
</code></pre></div>

<p>Có thể đổi time offset 1 tuần trước</p>
<div class="highlight"><pre><span></span><code>prometheus_http_requests_total{handler=&quot;/api/v1/query&quot;} offset 1w
</code></pre></div>

<p>Có thể chọn thời gian tính toán kết quả</p>
<div class="highlight"><pre><span></span><code><span class="n">prometheus_http_requests_total</span><span class="p">{</span><span class="n">handler</span><span class="o">=</span><span class="s">&quot;/api/v1/query&quot;</span><span class="p">}</span><span class="w"> </span><span class="mf">@1726148884.174</span><span class="w"></span>
</code></pre></div>

<p>Xem chi tiết tại <a href="https://prometheus.io/docs/prometheus/2.53/querying/basics/#offset-modifier">https://prometheus.io/docs/prometheus/2.53/querying/basics/#offset-modifier</a></p>
<h3>Instant query và range query</h3>
<p>Instant query và range query là 2 API của Prometheus.</p>
<h4>Instant query</h4>
<p><a href="https://prometheus.io/docs/prometheus/2.53/querying/api/#instant-queries">Doc</a>
<a href="https://github.com/prometheus/prometheus/blob/v2.53.0/web/api/v1/api.go#L421">Code</a></p>
<blockquote>
<p>The following endpoint evaluates an instant query at a single point in time:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="err">GET /api/v1/query</span>
<span class="err">POST /api/v1/query</span>
</code></pre></div>

<p>API này trả về kết quả của PromQL query tại 1 thời điểm (mặc định là thời điểm hiện tại), xem ở dạng bảng (table):</p>
<p><img alt="instant query" src="./images/prom_instant_query.webp"></p>
<blockquote>
<p>The data section of the query result has the following format:</p>
<p>{
  "resultType": "matrix" | "vector" | "scalar" | "string",
  "result": <value>
}</p>
</blockquote>
<p>Query dùng instant vector selector <code>up</code> trả về vector</p>
<div class="highlight"><pre><span></span><code>$ curl <span class="s1">&#39;http://localhost:9090/api/v1/query?query=up&amp;time=1728562908.678&#39;</span>
<span class="o">{</span><span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;success&quot;</span>,<span class="s2">&quot;data&quot;</span>:<span class="o">{</span><span class="s2">&quot;resultType&quot;</span>:<span class="s2">&quot;vector&quot;</span>,<span class="s2">&quot;result&quot;</span>:<span class="o">[{</span><span class="s2">&quot;metric&quot;</span>:<span class="o">{</span><span class="s2">&quot;__name__&quot;</span>:<span class="s2">&quot;up&quot;</span>,<span class="s2">&quot;instance&quot;</span>:<span class="s2">&quot;localhost:9090&quot;</span>,<span class="s2">&quot;job&quot;</span>:<span class="s2">&quot;prometheus&quot;</span><span class="o">}</span>,<span class="s2">&quot;value&quot;</span>:<span class="o">[</span><span class="m">1728562908</span>.678,<span class="s2">&quot;1&quot;</span><span class="o">]}]}}</span>
</code></pre></div>

<p>Query dùng range vector selector <code>up[1m]</code> trả về matrix</p>
<div class="highlight"><pre><span></span><code>$ curl <span class="s1">&#39;http://localhost:9090/api/v1/query?query=up%5B1m%5D&amp;time=1728563140.405&#39;</span>
<span class="o">{</span><span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;success&quot;</span>,<span class="s2">&quot;data&quot;</span>:<span class="o">{</span><span class="s2">&quot;resultType&quot;</span>:<span class="s2">&quot;matrix&quot;</span>,<span class="s2">&quot;result&quot;</span>:<span class="o">[{</span><span class="s2">&quot;metric&quot;</span>:<span class="o">{</span><span class="s2">&quot;__name__&quot;</span>:<span class="s2">&quot;up&quot;</span>,<span class="s2">&quot;instance&quot;</span>:<span class="s2">&quot;localhost:9090&quot;</span>,<span class="s2">&quot;job&quot;</span>:<span class="s2">&quot;prometheus&quot;</span><span class="o">}</span>,<span class="s2">&quot;values&quot;</span>:<span class="o">[[</span><span class="m">1728563087</span>.296,<span class="s2">&quot;1&quot;</span><span class="o">]</span>,<span class="o">[</span><span class="m">1728563102</span>.296,<span class="s2">&quot;1&quot;</span><span class="o">]</span>,<span class="o">[</span><span class="m">1728563117</span>.294,<span class="s2">&quot;1&quot;</span><span class="o">]</span>,<span class="o">[</span><span class="m">1728563132</span>.297,<span class="s2">&quot;1&quot;</span><span class="o">]]}]}}</span>
</code></pre></div>

<p>Instant query thường được Prometheus dùng khi tính toán các rule để gửi alert.</p>
<h4>Range query</h4>
<p><a href="https://prometheus.io/docs/prometheus/2.53/querying/api/#range-queries">Doc</a>
<a href="https://github.com/prometheus/prometheus/blob/v2.53.0/web/api/v1/api.go#L500">Code</a></p>
<blockquote>
<p>The following endpoint evaluates an expression query over a range of time:</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="err">GET /api/v1/query_range</span>
<span class="err">POST /api/v1/query_range</span>
</code></pre></div>

<p>API này sẽ trả về kết quả của PromQL query tại 1 khoảng thời gian.
Nó chỉ nhận 2 loại kiểu dữ liệu là instant vector và scalar. Thử query <code>up[1m]</code> sẽ nhận được lỗi:</p>
<div class="highlight"><pre><span></span><code>$ curl <span class="s1">&#39;http://localhost:9090/api/v1/query_range?query=up%5B1m%5D&amp;start=1728558788.318&amp;end=1728562388.318&amp;step=14&#39;</span>
<span class="o">{</span><span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;error&quot;</span>,<span class="s2">&quot;errorType&quot;</span>:<span class="s2">&quot;bad_data&quot;</span>,<span class="s2">&quot;error&quot;</span>:<span class="s2">&quot;invalid parameter \&quot;query\&quot;: invalid expression type \&quot;range vector\&quot; for range query, must be Scalar or instant Vector&quot;</span><span class="o">}</span>
</code></pre></div>

<p>Range query giống như thực hiện instant query qua nhiều thời điểm khác nhau rồi gộp kết quả lại thành 1 matrix.
Kết quả là mỗi time series sẽ có nhiều sample và có thể dùng vẽ đồ thị.</p>
<p><img alt="range query" src="./images/prom_range_query.webp"></p>
<p>Range query chủ yếu dùng để vẽ đồ thị (graph), phần mềm vẽ đồ thị như Grafana sẽ gọi qua API này.</p>
<p>Xem hình vẽ từ <a href="https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/#range-queries">blog PromLab</a> mô tả cách range query thực hiện:</p>
<p><img alt="range query explain" src="https://promlabs.com/images/range_query.svg"></p>
<h2>Kết luận</h2>
<p>Prometheus cơ bản thật không hề đơn giản.</p>
<p>Hết.</p>
<h2>Tham khảo</h2>
<ul>
<li><a href="https://sre.google/sre-book/practical-alerting/">Site Reliability Engineering &gt; Practical Alerting from Time-Series Data</a></li>
<li><a href="https://promlabs.com/blog/2020/06/18/the-anatomy-of-a-promql-query/">The Anatomy of a PromQL Query</a></li>
<li>Range vector is matrix <a href="https://github.com/prometheus/prometheus/issues/2196">https://github.com/prometheus/prometheus/issues/2196</a></li>
<li>Range query only support scalar-typed and instant-vector-typed expressions <a href="https://github.com/prometheus/prometheus/pull/15084/files">https://github.com/prometheus/prometheus/pull/15084/files</a></li>
</ul>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2024-10-02T00:00:00+07:00">Wed 02 October 2024</time>
<h4>Last Updated</h4>
<time datetime="2024-10-10T00:00:00+07:00">Thu 10 October 2024</time>

            <h4>Category</h4>
            <a class="category-link" href="./categories.html#frontpage-ref">frontpage</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="./tags.html#go-ref">go
                    <span class="superscript">12</span>
</a></li>
                <li><a href="./tags.html#metric-ref">metric
                    <span class="superscript">3</span>
</a></li>
                <li><a href="./tags.html#prometheus-ref">prometheus
                    <span class="superscript">4</span>
</a></li>
                <li><a href="./tags.html#readcode-ref">readcode
                    <span class="superscript">5</span>
</a></li>
                <li><a href="./tags.html#timeseries-ref">timeseries
                    <span class="superscript">3</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="./theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>